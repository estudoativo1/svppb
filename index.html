<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>si vis pacem para bellum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --light-bg-color: #f3f4f6;
            --light-container-bg: #ffffff;
            --light-text-color: #1f2937;
            --light-secondary-text: #4b5563;
            --light-card-bg: #e5e7eb;
            --light-input-bg: #ffffff;
            --light-input-border: #d1d5db;
            --light-error-color: #ef4444;
            --light-shadow-color: rgba(0, 0, 0, 0.1);
        }

        .dark-mode {
            --dark-bg-color: #111827;
            --dark-container-bg: #1f2937;
            --dark-text-color: #f3f4f6;
            --dark-secondary-text: #9ca3af;
            --dark-card-bg: #374151;
            --dark-input-bg: #1f2937;
            --dark-input-border: #4b5563;
            --dark-error-color: #f87171;
            --dark-shadow-color: rgba(0, 0, 0, 0.3);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--light-bg-color);
            transition: background-color 0.3s ease;
            letter-spacing: -0.01em; /* Subtle letter spacing adjustment */
        }

        body.dark-mode {
            background-color: var(--dark-bg-color);
        }

        .container {
            background-color: var(--light-container-bg);
            color: var(--light-text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
            box-shadow: 0 10px 15px -3px var(--light-shadow-color), 0 4px 6px -2px var(--light-shadow-color); /* Softer shadow */
        }
        
        body.dark-mode .container {
            background-color: var(--dark-container-bg);
            color: var(--dark-text-color);
            box-shadow: 0 10px 15px -3px var(--dark-shadow-color), 0 4px 6px -2px var(--dark-shadow-color);
        }

        .bg-gray-100 {
            background-color: var(--light-card-bg);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); /* Card shadow */
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        
        body.dark-mode .bg-gray-100 {
            background-color: var(--dark-card-bg);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.12);
        }

        .bg-gray-100:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        body.dark-mode .bg-gray-100:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.15);
        }

        .text-gray-800 {
            color: var(--light-text-color);
        }
        
        body.dark-mode .text-gray-800 {
            color: var(--dark-text-color);
        }

        .text-gray-600 {
            color: var(--light-secondary-text);
        }
        
        body.dark-mode .text-gray-600 {
            color: var(--dark-secondary-text);
        }

        .text-gray-700 {
            color: var(--light-secondary-text);
        }

        body.dark-mode .text-gray-700 {
            color: var(--dark-text-color);
        }

        .border-gray-300 {
            border-color: var(--light-input-border);
        }
        
        body.dark-mode .border-gray-300 {
            border-color: var(--dark-input-border);
        }

        .form-radio {
            color: #63b3ed;
        }

        /* Custom styles for improvements */
        .select-error {
            border-color: var(--light-error-color) !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.5) !important; /* Tailwind red-500 with opacity */
        }
        body.dark-mode .select-error {
            border-color: var(--dark-error-color) !important;
            box-shadow: 0 0 0 3px rgba(248, 113, 113, 0.5) !important; /* Tailwind red-400 with opacity */
        }

        .question-card-enter {
            opacity: 0;
            transform: translateY(20px);
        }
        .question-card-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        /* Skeleton Loader */
        .skeleton-loader {
            background: linear-gradient(90deg, var(--light-card-bg) 25%, #e0e0e0 50%, var(--light-card-bg) 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 0.5rem;
        }
        body.dark-mode .skeleton-loader {
            background: linear-gradient(90deg, var(--dark-card-bg) 25%, #4a5568 50%, var(--dark-card-bg) 75%);
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-text {
            height: 1em;
            margin-bottom: 0.5em;
        }
        .skeleton-text-lg {
            height: 1.5em;
            width: 80%;
        }
        .skeleton-text-sm {
            height: 1em;
            width: 60%;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4 sm:p-6 md:p-8 relative">

    <!-- Dark Mode Toggle Button -->
    <button id="theme-toggle" class="absolute top-4 right-4 p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 shadow-md hover:scale-105 transition-transform focus:outline-none focus:ring-2 focus:ring-indigo-500" aria-label="Alternar modo claro/escuro">
        <svg class="h-6 w-6 block dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h1M3 12H2m8.003-9.997a4.5 4.5 0 015.994 5.994L12 12l-2.003 2.003a4.5 4.5 0 01-5.994-5.994L12 12l2.003-2.003a4.5 4.5 0 015.994 5.994z"></path></svg>
        <svg class="h-6 w-6 hidden dark:block" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"></path></svg>
    </button>

    <div class="container rounded-2xl shadow-xl w-full max-w-xl md:max-w-3xl p-6 sm:p-8 md:p-12 flex flex-col items-center">
        <!-- Título e descrição -->
        <h1 class="text-3xl sm:text-4xl font-bold text-center mb-2 tracking-wide">si vis pacem para bellum</h1>
        <p class="text-center text-sm sm:text-base mb-8 md:mb-12 text-gray-600 leading-relaxed">Selecione uma disciplina e o número de questões para gerar seu simulado de Certo/Errado.</p>
        
        <!-- Contêiner de seleção e botão -->
        <div class="w-full mb-8 flex flex-col md:flex-row items-center justify-center space-y-4 md:space-y-0 md:space-x-4">
            <div class="relative w-full md:w-1/2">
                <select id="subject-select" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200 transition-all duration-200 ease-in-out" aria-label="Escolha uma disciplina">
                    <option value="" disabled selected>Escolha uma disciplina</option>
                    <option value="Direito Constitucional">Direito Constitucional</option>
                    <option value="Direitos Humanos">Direitos Humanos</option>
                    <option value="Direito Administrativo">Direito Administrativo</option>
                    <option value="Direito Penal">Direito Penal</option>
                    <option value="Direito Processual Penal">Direito Processual Penal</option>
                </select>
                <button id="clear-subject-btn" class="absolute right-3 top-1/2 -translate-y-1/2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-200 focus:outline-none" aria-label="Limpar seleção de disciplina" title="Limpar seleção">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
                <p id="subject-error" class="absolute -bottom-6 left-0 text-red-500 text-xs hidden">Por favor, selecione uma disciplina.</p>
            </div>
            <div class="w-full md:w-1/4">
                <input type="number" id="num-questions" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 bg-white dark:bg-gray-700 text-gray-800 dark:text-gray-200" value="5" min="1" max="10" aria-label="Número de questões" title="Número de questões (1-10)">
            </div>
            <button id="generate-btn" class="w-full md:w-auto px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 transform hover:scale-105" aria-label="Gerar Questões">
                Gerar Questões
            </button>
        </div>

        <!-- Mensagens de carregamento e erro -->
        <div id="loading" class="hidden text-center text-gray-500 dark:text-gray-400 mb-6">
            <div class="animate-spin rounded-full h-8 w-8 border-4 border-t-indigo-500 border-gray-200 mx-auto mb-2"></div>
            <span>Gerando questões...</span>
        </div>
        <div id="success-message" class="hidden text-center text-green-600 dark:text-green-400 font-medium mb-6"></div>
        <div id="error-message" class="hidden text-center text-red-500 dark:text-red-400 font-medium mb-6"></div>

        <!-- Contêiner das questões -->
        <div id="questions-container" class="w-full space-y-6"></div>

        <!-- Botão para abrir o Dashboard -->
        <button id="open-dashboard-btn" class="w-full mt-8 px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 transform hover:scale-105" aria-label="Abrir Dashboard de Desempenho">
            Ver Desempenho
        </button>
    </div>

    <!-- Overlay e Modal do Dashboard -->
    <div id="dashboard-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-xl w-11/12 max-w-2xl relative">
            <h2 class="text-2xl font-bold text-gray-800 dark:text-gray-100 mb-4">Dashboard de Desempenho</h2>
            
            <div id="dashboard-content" class="space-y-4 text-gray-700 dark:text-gray-300">
                <!-- Conteúdo do dashboard será injetado aqui -->
                <p id="overall-accuracy" class="text-lg font-semibold"></p>
                <div id="subject-performance" class="space-y-2">
                    <!-- Desempenho por matéria será injetado aqui -->
                </div>
            </div>

            <div class="mt-6 flex justify-end space-x-4">
                <button id="reset-dashboard-btn" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                    Resetar Dados
                </button>
                <button id="close-dashboard-btn" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-lg hover:bg-gray-400 transition-colors dark:bg-gray-700 dark:text-gray-200">
                    Fechar
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const subjectSelect = document.getElementById('subject-select');
            const numQuestionsInput = document.getElementById('num-questions');
            const generateBtn = document.getElementById('generate-btn');
            const questionsContainer = document.getElementById('questions-container');
            const loadingIndicator = document.getElementById('loading');
            const errorMessage = document.getElementById('error-message');
            const successMessage = document.getElementById('success-message');
            const subjectError = document.getElementById('subject-error');
            const themeToggle = document.getElementById('theme-toggle');
            const clearSubjectBtn = document.getElementById('clear-subject-btn');

            // Novas constantes para os elementos do dashboard
            const openDashboardBtn = document.getElementById('open-dashboard-btn');
            const dashboardOverlay = document.getElementById('dashboard-overlay');
            const closeDashboardBtn = document.getElementById('close-dashboard-btn');
            const resetDashboardBtn = document.getElementById('reset-dashboard-btn');
            const dashboardContent = document.getElementById('dashboard-content');
            const overallAccuracyDisplay = document.getElementById('overall-accuracy');
            const subjectPerformanceDisplay = document.getElementById('subject-performance');

            const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=AIzaSyA5yXOkwfWOLPv7pnL3ZacEsiuzX8e9JQ4";

            // Dark Mode Toggle Functionality
            themeToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
            });

            // Apply saved theme on load
            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
            }

            // Clear Subject Selection
            clearSubjectBtn.addEventListener('click', () => {
                subjectSelect.value = "";
                subjectSelect.classList.remove('select-error');
                subjectError.classList.add('hidden');
                errorMessage.classList.add('hidden');
            });

            // Function to display skeleton loaders
            function showSkeletonLoaders(count) {
                questionsContainer.innerHTML = '';
                for (let i = 0; i < count; i++) {
                    const skeletonCard = document.createElement('div');
                    skeletonCard.className = 'bg-gray-100 dark:bg-gray-800 p-6 rounded-xl shadow-md';
                    skeletonCard.innerHTML = `
                        <div class="skeleton-loader skeleton-text-lg w-3/4 mb-4"></div>
                        <div class="skeleton-loader skeleton-text w-full mb-2"></div>
                        <div class="skeleton-loader skeleton-text w-1/2 mb-4"></div>
                        <div class="skeleton-loader skeleton-text-sm w-1/3"></div>
                    `;
                    questionsContainer.appendChild(skeletonCard);
                }
            }

            // Function to generate questions with the Gemini API
            async function generateQuestions() {
                const subject = subjectSelect.value;
                const numQuestions = parseInt(numQuestionsInput.value, 10);

                // Clear previous messages and styles
                questionsContainer.innerHTML = '';
                errorMessage.classList.add('hidden');
                successMessage.classList.add('hidden');
                subjectSelect.classList.remove('select-error');
                subjectError.classList.add('hidden');

                if (!subject) {
                    subjectSelect.classList.add('select-error');
                    subjectError.classList.remove('hidden');
                    showError("Por favor, selecione uma disciplina.");
                    return;
                }
                if (isNaN(numQuestions) || numQuestions < 1 || numQuestions > 10) {
                    showError("Por favor, insira um número de questões entre 1 e 10.");
                    return;
                }

                loadingIndicator.classList.remove('hidden');
                generateBtn.disabled = true;
                showSkeletonLoaders(numQuestions); // Show skeleton loaders

                const userPrompt = `Gere ${numQuestions} questões de 'Certo/Errado' sobre ${subject} para um concurso público. Para cada questão, inclua a resposta e uma breve explicação da resolução.`;
                
                const payload = {
                    contents: [{ parts: [{ text: userPrompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "question": { "type": "STRING" },
                                    "answer": { "type": "BOOLEAN" },
                                    "resolution": { "type": "STRING" }
                                },
                                "propertyOrdering": ["question", "answer", "resolution"]
                            }
                        }
                    }
                };

                try {
                    const response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API Error: ${response.status} - ${errorData.error.message}`);
                    }

                    const result = await response.json();
                    const jsonString = result.candidates[0].content.parts[0].text;
                    const questions = JSON.parse(jsonString);

                    questionsContainer.innerHTML = ''; // Clear skeletons
                    displayQuestions(questions);
                    showSuccess(`Geradas ${questions.length} questões de ${subject}!`);

                } catch (error) {
                    console.error("Failed to generate questions:", error);
                    showError("Falha ao gerar questões. Tente novamente mais tarde.");
                } finally {
                    loadingIndicator.classList.add('hidden');
                    generateBtn.disabled = false;
                }
            }

            // Function to display questions on the page
            function displayQuestions(questions) {
                questions.forEach((q, index) => {
                    const questionCard = document.createElement('div');
                    questionCard.className = 'bg-gray-100 dark:bg-gray-800 p-6 rounded-xl shadow-md question-card-enter';
                    questionCard.innerHTML = `
                        <p class="font-medium text-lg mb-4 text-gray-800 dark:text-gray-100 leading-relaxed">${index + 1}. ${q.question}</p>
                        <div class="flex flex-col space-y-2">
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" class="form-radio h-5 w-5 text-indigo-600 dark:text-indigo-400" name="q-${index}" value="true" data-correct-answer="${q.answer}">
                                <span class="ml-2 text-gray-700 dark:text-gray-300">Certo</span>
                            </label>
                            <label class="inline-flex items-center cursor-pointer">
                                <input type="radio" class="form-radio h-5 w-5 text-indigo-600 dark:text-indigo-400" name="q-${index}" value="false" data-correct-answer="${q.answer}">
                                <span class="ml-2 text-gray-700 dark:text-gray-300">Errado</span>
                            </label>
                        </div>
                        <div class="mt-4 hidden font-medium text-sm result-message flex items-center space-x-2"></div>
                        <div class="mt-4 hidden text-sm p-4 rounded-lg bg-white dark:bg-gray-700 resolution-comment">
                            <p class="font-bold text-gray-800 dark:text-gray-100">Resolução:</p>
                            <p class="text-gray-700 dark:text-gray-200 mt-1 leading-relaxed">${q.resolution}</p>
                            <button class="toggle-resolution-btn mt-2 text-indigo-600 dark:text-indigo-400 hover:underline text-xs focus:outline-none">Ocultar Resolução</button>
                        </div>
                        <button class="toggle-resolution-btn mt-4 text-indigo-600 dark:text-indigo-400 hover:underline text-sm hidden focus:outline-none">Mostrar Resolução</button>
                    `;
                    questionsContainer.appendChild(questionCard);
                    // Trigger animation
                    setTimeout(() => {
                        questionCard.classList.remove('question-card-enter');
                        questionCard.classList.add('question-card-enter-active');
                    }, 50 * index); // Stagger animation
                });

                // Add a button to check answers
                const checkBtn = document.createElement('button');
                checkBtn.id = 'check-btn';
                checkBtn.className = 'w-full mt-6 px-6 py-3 bg-green-600 text-white font-semibold rounded-lg shadow-md hover:bg-green-700 transition-colors focus:outline-none focus:ring-2 focus:ring-green-500 transform hover:scale-105';
                checkBtn.textContent = 'Verificar Respostas';
                questionsContainer.appendChild(checkBtn);

                checkBtn.addEventListener('click', checkAnswers);
            }

            // Função para inicializar o histórico do dashboard
            let performanceData = JSON.parse(localStorage.getItem('quizPerformance')) || {};

            // Função para salvar os dados no localStorage
            function savePerformanceData() {
                localStorage.setItem('quizPerformance', JSON.stringify(performanceData));
            }

            // Função para atualizar o desempenho após cada verificação de respostas
            function updatePerformance(subject, questions) {
                if (!performanceData[subject]) {
                    performanceData[subject] = { total: 0, correct: 0 };
                }

                let currentCorrect = 0;
                questions.forEach(q => {
                    const radios = q.querySelectorAll('input[type="radio"]');
                    radios.forEach(radio => {
                        if (radio.checked) {
                            const isCorrect = radio.value === radio.dataset.correctAnswer;
                            if (isCorrect) {
                                currentCorrect++;
                            }
                        }
                    });
                });

                performanceData[subject].total += questions.length;
                performanceData[subject].correct += currentCorrect;
                savePerformanceData();
            }

            // Função original para verificar respostas
            const originalCheckAnswers = function() {
                const questions = questionsContainer.querySelectorAll('.bg-gray-100');
                let allAnswered = true;
                let correctCount = 0;

                questions.forEach(q => {
                    const radios = q.querySelectorAll('input[type="radio"]');
                    let isAnswered = false;
                    const resultMessage = q.querySelector('.result-message');
                    const resolutionComment = q.querySelector('.resolution-comment');
                    const toggleResolutionBtn = q.querySelector('.toggle-resolution-btn');

                    radios.forEach(radio => {
                        if (radio.checked) {
                            isAnswered = true;
                            const isCorrect = radio.value === radio.dataset.correctAnswer;
                            
                            resultMessage.classList.remove('hidden');
                            
                            if (isCorrect) {
                                correctCount++;
                                resultMessage.innerHTML = `<svg class="h-5 w-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> <span>Resposta correta!</span>`;
                                resultMessage.classList.remove('text-red-500');
                                resultMessage.classList.add('text-green-600');
                                resolutionComment.classList.add('hidden'); // Hide resolution for correct answers by default
                                toggleResolutionBtn.textContent = 'Mostrar Resolução';
                                toggleResolutionBtn.classList.remove('hidden');
                            } else {
                                resultMessage.innerHTML = `<svg class="h-5 w-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg> <span>Resposta incorreta.</span>`;
                                resultMessage.classList.remove('text-green-600');
                                resultMessage.classList.add('text-red-500');
                                resolutionComment.classList.remove('hidden'); // Show resolution if answer is incorrect
                                toggleResolutionBtn.textContent = 'Ocultar Resolução';
                                toggleResolutionBtn.classList.remove('hidden');
                            }
                        }
                    });
                    if (!isAnswered) {
                        allAnswered = false;
                    }

                    // Add event listener for toggle resolution button (ensure only one listener per button)
                    if (!toggleResolutionBtn.dataset.listenerAdded) {
                        toggleResolutionBtn.addEventListener('click', () => {
                            resolutionComment.classList.toggle('hidden');
                            if (resolutionComment.classList.contains('hidden')) {
                                toggleResolutionBtn.textContent = 'Mostrar Resolução';
                            } else {
                                toggleResolutionBtn.textContent = 'Ocultar Resolução';
                            }
                        });
                        toggleResolutionBtn.dataset.listenerAdded = true;
                    }
                });

                if (!allAnswered) {
                    showError("Por favor, responda a todas as questões antes de verificar.");
                    return;
                }
                
                // Hide check button and show "next" button
                document.getElementById('check-btn').classList.add('hidden');
                
                const nextBtn = document.createElement('button');
                nextBtn.id = 'next-btn';
                nextBtn.className = 'w-full mt-6 px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors focus:outline-none focus:ring-2 focus:ring-indigo-500 transform hover:scale-105';
                nextBtn.textContent = 'Gerar Novas Questões';
                questionsContainer.appendChild(nextBtn);

                nextBtn.addEventListener('click', () => {
                    generateQuestions();
                    questionsContainer.removeChild(nextBtn);
                });

                // Update overall error message to show score
                errorMessage.classList.remove('hidden');
                if (correctCount === questions.length) {
                    errorMessage.textContent = `Parabéns! Você acertou todas as ${questions.length} questões!`;
                    errorMessage.classList.remove('text-red-500');
                    errorMessage.classList.add('text-green-600');
                } else {
                    errorMessage.textContent = `Você acertou ${correctCount} de ${questions.length} questões. Continue praticando!`;
                    errorMessage.classList.remove('text-green-600');
                    errorMessage.classList.add('text-red-500');
                }
            };

            // Modificar a função checkAnswers para chamar updatePerformance
            // A função checkAnswers agora é uma wrapper que chama a original e depois atualiza o dashboard
            window.checkAnswers = function() { // Torna global para ser acessível pelo addEventListener
                originalCheckAnswers(); // Chama a função original para verificar e exibir resultados

                const subject = subjectSelect.value;
                const questions = questionsContainer.querySelectorAll('.bg-gray-100');
                updatePerformance(subject, Array.from(questions)); // Converte NodeList para Array
                renderDashboard(); // Atualiza o dashboard imediatamente
            };


            // Função para renderizar o dashboard
            function renderDashboard() {
                let totalQuestionsOverall = 0;
                let correctQuestionsOverall = 0;
                subjectPerformanceDisplay.innerHTML = ''; // Limpa o conteúdo anterior

                for (const subject in performanceData) {
                    const data = performanceData[subject];
                    const accuracy = data.total > 0 ? ((data.correct / data.total) * 100).toFixed(2) : 0;
                    totalQuestionsOverall += data.total;
                    correctQuestionsOverall += data.correct;

                    const subjectDiv = document.createElement('div');
                    subjectDiv.className = 'p-3 bg-gray-50 dark:bg-gray-700 rounded-md';
                    subjectDiv.innerHTML = `
                        <p class="font-medium">${subject}:</p>
                        <p>Questões Respondidas: ${data.total}</p>
                        <p>Acertos: ${data.correct}</p>
                        <p>Taxa de Acerto: ${accuracy}%</p>
                    `;
                    subjectPerformanceDisplay.appendChild(subjectDiv);
                }

                const overallAccuracy = totalQuestionsOverall > 0 ? ((correctQuestionsOverall / totalQuestionsOverall) * 100).toFixed(2) : 0;
                overallAccuracyDisplay.innerHTML = `
                    <p>Total de Questões Respondidas: ${totalQuestionsOverall}</p>
                    <p>Total de Acertos: ${correctQuestionsOverall}</p>
                    <p><strong>Taxa de Acerto Geral: ${overallAccuracy}%</strong></p>
                `;
            }

            // Event Listeners para o Dashboard
            openDashboardBtn.addEventListener('click', () => {
                renderDashboard(); // Renderiza o dashboard antes de abrir
                dashboardOverlay.classList.remove('hidden');
            });

            closeDashboardBtn.addEventListener('click', () => {
                dashboardOverlay.classList.add('hidden');
            });

            resetDashboardBtn.addEventListener('click', () => {
                if (confirm('Tem certeza que deseja resetar todos os dados de desempenho? Esta ação é irreversível.')) {
                    performanceData = {}; // Limpa os dados
                    savePerformanceData(); // Salva o estado vazio
                    renderDashboard(); // Renderiza o dashboard vazio
                    alert('Dados de desempenho resetados com sucesso!');
                }
            });

            // Opcional: Fechar o dashboard clicando fora do modal
            dashboardOverlay.addEventListener('click', (e) => {
                if (e.target === dashboardOverlay) {
                    dashboardOverlay.classList.add('hidden');
                }
            });

            // Renderiza o dashboard na carga inicial (se houver dados salvos)
            renderDashboard();

            // Function to display a temporary error message
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.classList.remove('hidden');
                successMessage.classList.add('hidden'); // Hide success message if error occurs
            }

            // Function to display a temporary success message
            function showSuccess(message) {
                successMessage.textContent = message;
                successMessage.classList.remove('hidden');
                errorMessage.classList.add('hidden'); // Hide error message if success occurs
                setTimeout(() => {
                    successMessage.classList.add('hidden');
                }, 3000); // Hide after 3 seconds
            }
            
            // Event listener for the main button
            generateBtn.addEventListener('click', () => {
                generateQuestions();
                generateBtn.textContent = 'Gerar Novas Questões'; // Change button text after first click
            });

            // Clear error message when subject selection changes
            subjectSelect.addEventListener('change', () => {
                subjectSelect.classList.remove('select-error');
                subjectError.classList.add('hidden');
                errorMessage.classList.add('hidden'); // Also hide general error message
            });
        });
    </script>
</body>
</html>
